name: Update Course Data

on:
  # Run every 30 minutes
  schedule:
    - cron: '*/30 * * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4
        sudo apt-get update && sudo apt-get install -y jq
    
    - name: Run scraper
      run: |
        cd scraper
        python scrape.py
        echo "✓ Scraper completed"
    
    - name: Verify ACTIVE_TERM was created
      run: |
        if [ ! -f "ACTIVE_TERM" ]; then
          echo "Error: ACTIVE_TERM file not created by scraper"
          exit 1
        fi
        ACTIVE_TERM=$(cat ACTIVE_TERM)
        echo "Active term detected: $ACTIVE_TERM"
        echo "ACTIVE_TERM=$ACTIVE_TERM" >> $GITHUB_ENV
    
    - name: Run parser
      run: |
        cd scraper
        python parse.py
        echo "✓ Parser completed"
    
    - name: Verify data file was created
      run: |
        FILENAME="${ACTIVE_TERM}data.txt"
        if [ ! -f "scraper/$FILENAME" ]; then
          echo "Error: $FILENAME not created by parser"
          exit 1
        fi
        SIZE=$(wc -c < "scraper/$FILENAME")
        echo "Data file created: $FILENAME (${SIZE} bytes)"
    
    - name: Commit data to repository
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        
        # Copy parsed data to root for commit (keep scraper/ clean in repo)
        cp "scraper/${ACTIVE_TERM}data.txt" "${ACTIVE_TERM}data.txt"
        cp "scraper/${ACTIVE_TERM}.json" "${ACTIVE_TERM}.json"
        cp "ACTIVE_TERM" "ACTIVE_TERM"
        
        # Add files
        git add "${ACTIVE_TERM}data.txt" "${ACTIVE_TERM}.json" "ACTIVE_TERM"
        
        # Commit if there are changes
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "chore: update course data for ${ACTIVE_TERM} - ${TIMESTAMP}"
          echo "✓ Committed course data changes"
        fi
    
    - name: Push changes to repository
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
    
    - name: Send to PythonAnywhere webhook
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
      run: |
        cd scraper
        python send_webhook.py
    
    - name: Upload artifacts (for debugging)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: scraper-output
        path: |
          ACTIVE_TERM
          scraper/*.json
          scraper/*data.txt
        retention-days: 7


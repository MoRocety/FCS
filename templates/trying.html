<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FCS</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <!-- Link to Bootstrap Slider CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css">
  <!-- Link to Bootstrap Slider JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@200&display=swap');
      *{
        font-family: 'Exo 2', sans-serif !important;      }
      .background-setter {
        background-color: #0d111b !important;
      }

      .white-color-setter-background {
        background-color: #f8f9fc !important;
      }
      .white-color-setter {
        color: #f8f9fc;
      }
      .input-color-setter {
        color: rgba(13, 17, 27, 0.5);
      }
      
      .filteredCourseP{
        margin-bottom: 0px !important;
      }

      hr {
        height: 2px;
        width: 100svw;
      }

      .line-container {
        background-color: #f8f9fc !important;
        height: 1px;
        width: 100%;
      }
      
      .custom-div {
      background-color: #181E30;
      border-radius: 10px; /* Rounded corners */
      padding: 20px;
      margin: 20px;
      max-width: 35rem;
      min-width: 15rem;
      margin: 0 auto;
      margin-top: 3rem;
      margin-bottom: 3rem;
      
      
    }
      .custom-input {
        background-color: rgba(13, 17, 27, 0.5);
        border: 1px solid rgba(13, 17, 27, 0.5);
        border-radius: 20px;
        padding: 10px;
        max-width: 30rem;
        max-height: 3rem;
        margin: 0 auto;
        font-weight: bold;
        text-transform: uppercase; 
        
      }
      .custom-input::placeholder {
        color: white;
      }

      .custom-input:focus {
        background-color: rgba(13, 17, 27, 0.5);
        border-color: rgba(13, 17, 27, 0.5);
      }

      .custom-input:hover {
        background-color: rgba(13, 17, 27, 0.5);
        border-color: rgba(13, 17, 27, 0.5);
      }

      .custom-button {
        background-color: #FFD700;
        border: none;
        border-radius: 20px;
        padding: 10px 20px;
        color: white;
        font-weight: bold;
        color: black;
        text-align: center;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2); /* Add shadow */
        display: block;
        margin: 0 auto;
        margin-top: 2rem !important;
        height: 2.75rem !important;
      }

      .custom-button:hover {
        background-color: white;
        color: black;
      }

      ::placeholder {
        font-weight: bold;
      }

      .input-div{
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 4rem;
      }


      .slider-track{
        margin-bottom: 1rem  !important;
      }
      .slider-handle{
        border: none;
        outline: none;
        background-image: linear-gradient(to bottom, #FFD700, #FFD700) !important;
      }

      .slider-track-low{
        border: none;
        outline: none;
        background-color: #0D111B !important;
      }

      .slider-track-high{
        border: none;
        outline: none;
        background-color: #0D111B !important;
      }

      .slider-selection{
        border: none;
        outline: none;
        background-image: linear-gradient(to bottom, #0D111B, #0D111B) !important;
      }

      .separator-line {
        height: 1rem;
        border: none;
        border-top: 10px solid #0d111b !important; /* Line color */
        margin: 0; /* Remove default margin */
        margin-top: 2rem;
        width: calc(100% + 2 * 20px); /* Account for the padding on both sides */
        margin-left: -20px; /* Counteract the left padding */
        margin-right: -20px; /* Counteract the right padding */
        opacity: 100%;
        
      }

      .slider.slider-horizontal{
        width: 70% !important;
      }

      #combinationMenu .custom-div{
        border-radius: 50px;
      }

      .custom-table {
          border-collapse: collapse;
          width: 100%;
          max-width: 900px;
          margin: auto;
          font-family: 'Exo 2', sans-serif;
      }

      .custom-table th, .custom-table td {
        border: 1px solid #ddd;
        padding-top: 38px;
        padding-left: 19px;
        padding-right: 19px;
        padding-bottom: 0;
        width: auto;
        position: relative;
        vertical-align: bottom; /* Vertically center the content */
        text-align: center; /* Horizontally center the content */
      }

      .cell-content {
        position: absolute;
        top: 0;
        height: 100%;
        left: 0;
        border-radius: 20px;
        width: 100%;
        background-color: rgba(127, 127, 127, 1);
        color: black; 
        z-index: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .custom-table td {
        color: #fff; /* White text color on dark background */
        width: 150px; 
        font-weight: bold;
      }

      .custom-table td, .cell-content {
        font-family: 'Exo 2', sans-serif;
      }

      tr:first-child td {
        border: none; /* Remove any existing borders */
        border-bottom: 1px; /* Apply a border only on the bottom */
        width: 150px; 
      }

      .combinations-list {
        display: flex;
        justify-content: center; /* Center horizontally */
        align-items: center; /* Center vertically */
      }
    
    </style>
  </head>
  <body class="background-setter">
    <h1 class="mt-1 ms-1 white-color-setter text-center"><strong>Forman Course Scheduler</strong></h1>
    <div class="line-container"></div>
    <section id="inputSection">
      
        <div class="custom-div white-color-setter">
          <div class="input-div">
            <div>

              <div  class="input-direct-div" style="margin-bottom: 2rem;">

                <input type="text" id="term-selector" list ="term" class="form-control custom-input white-color-setter text-center my-2" placeholder="Term" style="color: white;">
                <datalist id="term">
                  <option value="2023 Fall">
                  <option value="Pharmacy Program Fall 2023">
                </datalist>
              </div>
              <div class="input-direct-div" >
                <input type="text" id="course-selector" list="course" class="form-control custom-input white-color-setter text-center my-2" placeholder="Course" style="color: white;">
                <datalist id="course">
                </datalist>
              </div>
            </div>
            <div>
              <div class="input-direct-div" style="margin-bottom: 2rem;">                
                <input type="text" id="department-selector" list="department" class="form-control custom-input white-color-setter text-center my-2" placeholder="Department" style="color: white;">
                <datalist id="department">
                </datalist>
              </div>
              <div class="input-direct-div">

                <input type="text" id="instructor-selector" list="instructor" class="form-control custom-input white-color-setter text-center my-2" placeholder="Instructor" style="color: white;">
                <datalist id="instructor">
                </datalist>
              </div>
            </div>

          </div>

            <div class="button-div">
              <button class="btn custom-button mt-2" onclick="filterCourses()">Filter</button>
            </div>
   
        </div>

        </div>
    </section>
    <section id="filterCoursesSection", style="display: none;">
        <h1 class="mt-1 ms-1 white-color-setter text-center" style="font-weight: 900;">Filtered Courses</h1>
        <ul id="courses-list" style="list-style-type: none; "></ul>
    </section>

    <section id="shortlistedCoursesSection", style="display: none;">
      <h1 class="mt-1 ms-1 white-color-setter text-center" style="font-weight: 900;">Shortlisted Courses</h1>
        <!-- Selected courses will be dynamically added here -->
        <p id="selected-courses-count"   class="text-center" style="color:white;">
          Selected Courses Count: <strong>0</strong>
        </p>
        <ul id="selected-courses-list" style="list-style-type: none; "></ul>
      </section>

      <section id="combinationMenu" style="display: none;">
        <h1 class="mt-1 ms-1 white-color-setter text-center" style="font-weight: 900;">Schedule Menu</h1>
        <p id="selected-courses-count"   class="text-center" style="color:white;">
          Specify Credit Hours 
        </p>

        <div class="custom-div white-color-setter text-center form-group">
          <h6 class="mt-1 ms-1 white-color-setter text-center" style="font-weight: bold; margin-bottom: 1rem;">Credit Hour Range</h6>
          <div class="form-group">

            <span id="span1" class="text-center m-4">15</span>
            <input class="form-control text-center mb-5" id="credit-range" type="text" data-slider-id="credit-range-slider" data-slider-min="0" data-slider-max="22" data-slider-step="1" data-slider-value="[0,22]" style="margin-inline: 1rem !important;"/>
            <span id="span2" class="text-center m-4 ml-3">17</span>
          </div>

          <hr class="separator-line ">
        <h6 class="mt-1 ms-1 white-color-setter text-center" style="font-weight: bold; margin-bottom: 1rem;">Must Have Courses:</h6>
          <div id="crucialCoursesContainer" class="text-left">
            <!-- Existing HTML content -->
          </div>       
        </div>
        
        <div class="button-div" >
          <button class="btn custom-button mt-2" onclick="submitSelectedCourses()">Generate</button>
        </div>
      </section>

      <section id="combinations">
        <!-- Populate with divs accordingly -->
      </section>
    

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
      crossorigin="anonymous"
    ></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js"></script>
    <script>

      var selectedCourses = [];
      var selectedCoursesCount = 0;
      var crucialCheckboxes = [];
      var checkedCrucials = [];
      var currentTerm = "2023 FALL";
      var pgno = 1;
      const days = ["M", "T", "W", "R", "F"];
      const daydic = {"M": "Mon", "T": "Tue", "W": "Wed", "R": "Thu", "F": "Fri"};

      const colors = ["#9DF4F2", "#CAFA9B", "#7C99F5", "#E8A3F7", "#B5D6F6", "#C4FAFE", "#EAB2A0", "#F092A7", "#BDF29F", "#88C7DD", "#FAE4A0"];

      $(document).ready(function () {
        $(".select2").select2();

        // Initialize the Bootstrap slider
        var rangeSlider = new Slider("#credit-range", {
          tooltip: "hide"
        });

        rangeSlider.setValue([15, 17]);
        // Add event handler to the slider's "slide" event
        rangeSlider.on("slide", function (slideEvt) {

          const span1 = document.getElementById("span1")
          const span2 = document.getElementById("span2")
          
          span1.innerText = slideEvt[0];
          span2.innerText= slideEvt[1];
          
        });


        // Populate dropdown menus
        populateDropdown("#department", "/departments");
        populateDropdown("#course", "/courses");
        populateDropdown("#instructor", "/instructors");

        // Add event listeners to clear dropdown values on focus
        $("#term-selector").on("focus", function () {
          $(this).val(""); // Clear the value
        });

        $("#department-selector").on("focus", function () {
          var old = $(this).val();
          
          $(this).val(""); // Clear the value

          if (old !== "All" && old !== "") {
            populateDropdown("#course", "/courses");
            populateDropdown("#instructor", "/instructors");
          }
        });

        $("#course-selector").on("focus", function () {
          $(this).val(""); // Clear the value
          const selectedValue = $(this).val(); 
          updateCourse(selectedValue); 
        });

        $("#instructor-selector").on("focus", function () {
          $(this).val(""); // Clear the value
          const selectedValue = $(this).val(); 
          updateInstructor(selectedValue); 
        });

        
        $('#term-selector').on('change', function () {
          const selectedValue = $(this).val();

          if (selectedValue === '2023 Fall' || selectedValue === 'Pharmacy Program Fall 2023') {
            updateTerm(selectedValue)
          }
        

        });

        $('#department-selector').on('change', function () {
          const selectedValue = $(this).val();
          $("#course-selector").val("");
          $("#instructor-selector").val("");

          if (selectedValue === 'All' || selectedValue === '') {
            populateDropdown("#course", "/courses");
            populateDropdown("#instructor", "/instructors");
            
          } else {
            updateDepartment(selectedValue);
          }
        });

        $('#course-selector').on('change', function () {
          const selectedValue = $(this).val();  
          updateCourse(selectedValue);
          
        });

        $('#instructor-selector').on('change', function () {
          const selectedValue = $(this).val();

          if (selectedValue === 'All' || selectedValue === '') {
            populateDropdown("#course", "/courses");
            
          } else {
            updateInstructor(selectedValue);
          }
        });
        
        $('.custom-button').on('click', function () {
          const selectedTerm = $('#term-selector').val();
          if (selectedTerm !== currentTerm) {
              selectedCourses = [];
              selectedCoursesCount = 0;
              updateSelectedCoursesList();
              updateSelectedCoursesCount();

              currentTerm = selectedTerm;
              $("#filterCoursesSection").css("display", "none");
              $("#shortlistedCoursesSection").css("display", "none");
              $("#combinationMenu").css("display", "none");


          }
           
        });
        
      });

      function updateTerm(selectedValue) {
        $.ajax({
          url: "updateTerm",
          type: "POST",
          data: JSON.stringify({ selectedValue: selectedValue }),
          contentType: "application/json", 
          success: function () {
            
            dropdownCache["/departments"] = undefined;
            dropdownCache["/courses"] = undefined;
            dropdownCache["/instructors"] = undefined;

            populateDropdown("#department", "/departments");
            populateDropdown("#course", "/courses");
            populateDropdown("#instructor", "/instructors");

            $("#department-selector").val(''); // Clear the department dropdown
            $("#course-selector").val(''); // Clear the course dropdown
            $("#instructor-selector").val(''); // Clear the instructor dropdown

          }
        });
      }


      // Create an object to store cached dropdown options
      const dropdownCache = {};

      // Function to fetch dropdown options from the server
      function fetchDropdownOptions(selector, url) {
        return new Promise((resolve, reject) => {
          if (dropdownCache[url]) {
            // If options are already cached, return them
            resolve(dropdownCache[url]);
          } else {
            // Fetch options from the server
            $.ajax({
              url: url,
              type: 'GET',
              success: (response) => {
                const options = JSON.parse(response);
                dropdownCache[url] = options; // Cache the options
                resolve(options);
              },
              error: (error) => {
                reject(error);
              },
            });
          }
        });
      }

      // Populate dropdown based on cached or fetched options
      function populateDropdown(selector, url) {
        fetchDropdownOptions(selector, url)
          .then((options) => {
            const dropdown = $(selector);
            dropdown.empty();

            // Add the "All" option
            const allOption = $('<option>').attr('value', 'All').text('All');
            dropdown.append(allOption);
            
            options.forEach((option) => {
              const optionElement = $('<option>')
                .attr('value', option.value)
                .text(option.label);
              dropdown.append(optionElement);
            });
          })
          .catch((error) => {
            console.error('Error fetching dropdown options:', error);
          });
      }

      function filterCourses() {
        const selectedDepartment = $("#department-selector").val();
        const selectedCourse = $("#course-selector").val();
        const selectedInstructor = $("#instructor-selector").val();
        $.ajax({
          url: "/",
          type: "POST",
          data: {
            dropdown: selectedDepartment,
            dropdown2: selectedCourse,
            dropdown3: selectedInstructor,
            page: 1,
          },
          success: function (response) {
            const courses = JSON.parse(response);
            if (courses.length > 0) {
                $("#filterCoursesSection").removeAttr("style");
                displayCourses(courses);
            } else {
                $("#filterCoursesSection").css("display", "none");
            }
          },
        });
      }

      function displayCourses(courses) {
        const coursesList = $("#courses-list");
        coursesList.empty();

        courses.forEach((course) => {
          const li = $("<div class='custom-div white-color-setter' style='border-radius: 50px; display:flex; align-items:center; justify-content:start;gap: 1rem;'>");
            const liDiv = $("<div  style='border-radius: 50px; '></div>")
            const compositeKey = `${course.course_id}-${course.department_id}-${course.section}`;
          const checkbox = $('<input type="checkbox" style="display:inline-block">').attr(
            "value",
            compositeKey
          );

          // Check if the course is already selected
          const isSelected = selectedCourses.some(
            (selectedCourse) =>
              selectedCourse.course_id === course.course_id &&
              selectedCourse.department_id === course.department_id &&
              selectedCourse.section === course.section
          );
          if (isSelected) {
            checkbox.prop("checked", true);
          }

          checkbox.on("change", function () {
            if (this.checked) {
              addSelectedCourse(course);
              $("#shortlistedCoursesSection").removeAttr("style");
              $("#combinationMenu").removeAttr("style");

              
            } else {
              removeSelectedCourse(course);
              
            }
          });
          
          li.append(checkbox);
          li.append(liDiv)
          liDiv.append(
            ` <p class="filteredCourseP">${course.department_id} ${course.course_id} | <strong>${course.name}</strong> | Credits: <strong>${course.credits}</strong> </p>`
          );
          
          
          liDiv.append(
            ` <p class="filteredCourseP">Section: <strong>${course.section}</strong> | Instructor: <strong>${course.instructor_name}</strong></p>`
          );

          if (course.classroom !== "TBDTBD") {
            let classroomSlice;

            if (course.classroom.length === 11) {
              classroomSlice = -5;
            } else {
              classroomSlice = -4;
            }

            liDiv.append(
              ` <p class="filteredCourseP"><strong>${course.classroom.slice(classroomSlice)}</strong> | <strong>${course.days}</strong> | <strong>${course.start_time}</strong> to <strong>${course.end_time}</strong></p>`
            );
          }

          if (course.alternate_classroom !== "None") {
            let classroomSlice;

            if (course.alternate_classroom.length === 11) {
              classroomSlice = -5;
            } else {
              classroomSlice = -4;
            }
            
            liDiv.append(
              `<p class="filteredCourseP"><strong>${course.alternate_classroom.slice(classroomSlice)}</strong> | <strong>${course.alternate_days}</strong> | <strong>${course.alternate_start_time}</strong> to <strong>${course.alternate_end_time}</strong></p>`
            );
          }

          coursesList.append(li);
        });
      }
      

      function updateDepartment(selectedValue) {
        const dropdown2 = $("#course");
        const dropdown3 = $("#instructor");

        $.ajax({
            url: '/updateDepartment',
            type: 'POST',
            data: JSON.stringify({ data: selectedValue }), // Wrap selectedValue in an object
            contentType: 'application/json',
            success: function (response) {
                const options = JSON.parse(response);

                options.courses.unshift({value: 'All' });
                dropdown2.empty();
                options.courses.forEach(option => {
                    const optionElement = $('<option>').attr('value', option.value).text(option.label);
                    dropdown2.append(optionElement);
                });

                options.instructors.unshift({value: 'All' });
                dropdown3.empty();
                options.instructors.forEach(option => {
                    const optionElement = $('<option>').attr('value', option.value).text(option.label);
                    dropdown3.append(optionElement);
                });
            }
        });
      }

      function updateCourse(selectedValue) {
        const dropdown3 = $("#instructor");
        const departmentValue = $("#department-selector").val();

        $.ajax({
            url: '/updateCourse',
            type: 'POST',
            data: JSON.stringify({ department: departmentValue, data: selectedValue }), 
            contentType: 'application/json',
            success: function (response) {
              const options = JSON.parse(response);

              options.instructors.unshift({ value: 'All'}); 
              dropdown3.empty();
              options.instructors.forEach(option => {
                  const optionElement = $('<option>').attr('value', option.value).text(option.label);
                  dropdown3.append(optionElement);
              });
            }
        });
      }


      function updateInstructor(selectedValue) {
        const dropdown2 = $("#course");      
        const departmentValue = $("#department-selector").val();

        $.ajax({
            url: '/updateInstructor',
            type: 'POST',
            data: JSON.stringify({ department: departmentValue, data: selectedValue }), 
            contentType: 'application/json',
            success: function (response) {
                const options = JSON.parse(response);
              
                options.courses.unshift({value: 'All' });
                dropdown2.empty();
                options.courses.forEach(option => {
                    const optionElement = $('<option>').attr('value', option.value).text(option.label);
                    dropdown2.append(optionElement);
                });
            }
        });
      }
      

      function addSelectedCourse(course) {
        selectedCourses.push(course);
        selectedCoursesCount++;
        updateSelectedCoursesList();
        updateSelectedCoursesCount();

        // Check if the course already exists in the crucialCheckboxes array
        const isCourseExist = crucialCheckboxes.some(
          (item) =>
            item.course_id === course.course_id &&
            item.department_id === course.department_id
        );

        if (!isCourseExist) {
          crucialCheckboxes.push(course);
        }
        updateCrucialCourses();
      }

      function removeSelectedCourse(course) {
        const index = selectedCourses.findIndex(
          (c) =>
            c.course_id === course.course_id &&
            c.department_id === course.department_id &&
            c.section === course.section
        );

        if (index !== -1) {
          selectedCourses.splice(index, 1);
          selectedCoursesCount--;
          updateSelectedCoursesList();
          updateSelectedCoursesCount();

          const compositeKey = `${course.course_id}-${course.department_id}-${course.section}`;
          const checkbox = $(
            `input[type="checkbox"][value="${compositeKey}"]`
          );
          checkbox.prop("checked", false);

          // Check if the course is still present in the selectedCourses array
          const isCoursePresent = selectedCourses.some(
            (c) =>
              c.course_id === course.course_id &&
              c.department_id === course.department_id
          );

          if (!isCoursePresent) {
            // Remove the course from crucialCheckboxes array
            const crucialIndex = crucialCheckboxes.findIndex(
              (c) =>
                c.course_id === course.course_id &&
                c.department_id === course.department_id
            );
            if (crucialIndex !== -1) {
              crucialCheckboxes.splice(crucialIndex, 1);
            }

            // Remove the course from checkedCrucials array
            const checkedCrucialIndex = checkedCrucials.findIndex(
              (c) =>
                c.course_id === course.course_id &&
                c.department_id === course.department_id
            );
            if (checkedCrucialIndex !== -1) {
              checkedCrucials.splice(checkedCrucialIndex, 1);
            }
          }
        }

        // Check if there are any selected courses left
        if (selectedCourses.length === 0) {
            $("#shortlistedCoursesSection").css("display", "none");
            $("#combinationMenu").css("display", "none");


        }

        updateCrucialCourses();
      }

      function updateSelectedCoursesList() {
        const selectedCoursesList = $("#selected-courses-list");
        selectedCoursesList.empty();

        selectedCourses.forEach((course) => {
          const li = $("<div class='custom-div white-color-setter' style='border-radius: 50px; display:flex; align-items:center; justify-content:start;gap: 1rem;'>");
          const shortLiDiv = $("<div  style='border-radius: 50px; '></div>")

          const popButton = $(
            '<button class="btn btn-danger btn-sm">-</button>'
          );
          popButton.on("click", function () {
            removeSelectedCourse(course);
          });
          li.append(popButton);
          li.append(shortLiDiv)
          shortLiDiv.append(
            ` <p class="filteredCourseP">${course.department_id} ${course.course_id} | <strong>${course.name}</strong> | Credits: <strong>${course.credits}</strong> </p>`
          );
          
          shortLiDiv.append(
            ` <p class="filteredCourseP">Section: <strong>${course.section}</strong> | Instructor: <strong>${course.instructor_name}</strong></p>`
          );

          if (course.classroom !== "TBDTBD") {
            
            shortLiDiv.append(
              ` <p class="filteredCourseP"><strong>${course.classroom.slice(-4)}</strong> | <strong>${course.days}</strong> | <strong>${course.start_time}</strong> to <strong>${course.end_time}</strong></p>`
            );
          }

          if (course.alternate_classroom !== "None") {
            
            shortLiDiv.append(
              `<p class="filteredCourseP"><strong>${course.alternate_classroom.slice(-4)}</strong> | <strong>${course.alternate_days}</strong> | <strong>${course.alternate_start_time}</strong> to <strong>${course.alternate_end_time}</strong></p>`
            );
          }


        
          selectedCoursesList.append(li);
        });
      }

      function updateSelectedCoursesCount() {
        const selectedCoursesCountElement = $('#selected-courses-count');
        selectedCoursesCountElement.html(`Selected Courses Count: <strong>${selectedCoursesCount}</strong>`);
      }

      function updateCrucialCourses() {
        const crucialList = $("#crucialCoursesContainer");
        crucialList.empty();

        crucialCheckboxes.forEach((course) => {
          const li = $("<li style='list-style:none; text-align:left !important; margin-left:2rem'>");
          const compositeKey = `${course.course_id}-${course.department_id}`;
          const checkbox = $('<input type="checkbox">').attr(
            "value",
            compositeKey
          );

          // Check if the course is already selected
          const isChecked = checkedCrucials.some(
            (checkedCrucial) =>
              checkedCrucial.course_id === course.course_id &&
              checkedCrucial.department_id === course.department_id
          );
          if (isChecked) {
            checkbox.prop("checked", true);
          }

          checkbox.on("change", function () {
            if (this.checked) {
              checkedCrucials.push(course);
            } else {
              const index = checkedCrucials.findIndex(
                (c) =>
                  c.course_id === course.course_id &&
                  c.department_id === course.department_id
              );

              if (index !== -1) {
                checkedCrucials.splice(index, 1);

                const compositeKey = `${course.course_id}-${course.department_id}`;
                const checkbox = $(
                  `input[type="checkbox"][value="${compositeKey}"]`
                );
                checkbox.prop("checked", false);
              }
            }
          });

          // Append checkbox, course information, and line break outside the event handler
          li.append(checkbox);
          li.append(
            ` ${course.department_id} ${course.course_id} - <strong>${course.name}</strong>`
          );
          li.append("<br>");
          crucialList.append(li);
        });
      }

      function submitSelectedCourses() {
        // Retrieve the slider values
        const sliderValues = $("#credit-range").slider("getValue");
        
        const inputString = sliderValues[0].value;
        const integersArray = inputString.split(',').map(str => parseInt(str, 10));

        const minCredit = integersArray[0];
        const maxCredit = integersArray[1];

        // Prepare the data to be sent
        const data = {
          selectedCourses: selectedCourses.map((course) => ({
            course_id: course.course_id,
            department_id: course.department_id,
            section: course.section,
            instructor_name: course.instructor_name,
          })),
          checkedCrucials: checkedCrucials.map((course) => ({
            course_id: course.course_id,
            department_id: course.department_id,
          })),
          minCredit: minCredit,
          maxCredit: maxCredit,
        };

        // Send the data to the backend
        $.ajax({
          url: "/submit",
          type: "POST",
          data: JSON.stringify(data),
          contentType: "application/json",
          success: function (response) {
            createTable(JSON.parse(response));
          },
        });
      }

      function createTable(combinations) {
        const section = $("#combinations"); // Target the section with id "combinations"
        section.empty(); // Clear any existing content

        for (var combinationKey in combinations) {
            var combinationData = combinations[combinationKey];

            const newDiv = $("<div>").addClass("combinations-list"); // Create the new div
            const table = $("<table>").addClass("custom-table");

            const colorCount = colors.length - 1;
            var currentColorIndex = 0;
            const courseColorMap = {};

            for (let i = 8; i <= 18; i++) {
                const row = $("<tr>");
                
                if (i === 8) {
                    row.append($("<td>").text(format12HourTime(i)));

                    days.forEach(day => {
                        row.append($("<td>").text(daydic[day])); 
                    });

                } else {
                    row.append($("<td>").text(format12HourTime(i)));

                    days.forEach(day => {
                        const currentTd = $("<td>");
                        row.append(currentTd);

                        combinationData.forEach(function (course) {
                            if (courseColorMap[course.department_id + course.course_id] === undefined) {
                                courseColorMap[course.department_id + course.course_id] = colors[currentColorIndex];
                                currentColorIndex += 1;

                                if (currentColorIndex === colorCount) {
                                    currentColorIndex = 0;
                                }
                            }

                            if (course.days.includes(day) && parseInt(course.start_time) === (i - 1)) {
                                const startMinutes = parseInt(course.start_time.substring(course.start_time.length - 2));
                                const endMinutes = parseInt(course.end_time.substring(course.end_time.length - 2));
                                const startTimeHours = parseInt(course.start_time.substring(0, course.start_time.length - 3));
                                const endTimeHours = parseInt(course.end_time.substring(0, course.end_time.length - 3));

                                const topPercentage = (startMinutes / 60) * 100;
                                const heightPercentage = (((endTimeHours - startTimeHours) * 100) + ((endMinutes - startMinutes) * 100 / 60));

                                const cellContent = $("<div>").addClass("cell-content").css({
                                    "top": topPercentage + "%",
                                    "height": heightPercentage + "%",
                                    "background-color": courseColorMap[course.department_id + course.course_id]
                                }).text(course.department_id + course.course_id + " - " + course.section);

                                currentTd.append(cellContent);

                            }
                            
                            if (course.alternate_days.includes(day) && parseInt(course.alternate_start_time) === (i - 1)) {
                                const startMinutes = parseInt(course.start_time.substring(course.alternate_start_time.length - 2));
                                const endMinutes = parseInt(course.end_time.substring(course.alternate_end_time.length - 2));
                                const startTimeHours = parseInt(course.start_time.substring(0, course.alternate_start_time.length - 3));
                                const endTimeHours = parseInt(course.end_time.substring(0, course.alternate_end_time.length - 3));

                                const topPercentage = (startMinutes / 60) * 100;
                                const heightPercentage = (((endTimeHours - startTimeHours) * 100) + ((endMinutes - startMinutes) * 100 / 60));

                                const cellContent = $("<div>").addClass("cell-content").css({
                                    "top": topPercentage + "%",
                                    "height": heightPercentage + "%",
                                    "background-color": courseColorMap[course.department_id + course.course_id]
                                }).text(course.department_id + course.course_id + " - " + course.section);

                                currentTd.append(cellContent);

                              
                            }
                        });
                    });
                }
                table.append(row);
            }
            newDiv.append(table);
            section.append(newDiv);
        }
    }

    function format12HourTime(hour) {
      let suffix = hour >= 12 ? "PM" : "AM";
      hour = hour % 12 || 12;
      return `${hour}:00 ${suffix}`;
    }

    
    </script>
  </body>
</html>
